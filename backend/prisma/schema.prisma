generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---------------- USERS ----------------
model User {
  id         Int       @id @default(autoincrement())
  username   String    @unique
  email      String    @unique
  password   String
  role       Role
  status     String    @default("active")
  lastLogin  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  auditLogs      AuditLog[]
  loanApplications LoanApplication[]
  repossessions   Repossession[]
  archives        Archive[] @relation("ArchiveByUser")
}

enum Role {
  admin
  finance
}

// ---------------- AUDIT LOGS ----------------
model AuditLog {
  id          Int      @id @default(autoincrement())
  userId      Int
  module      String
  action      String
  recordId    Int?
  description String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// ---------------- MOTORS ----------------
model Motor {
  id             Int       @id @default(autoincrement())
  type           String
  brand          String
  model          String
  year           Int
  chassisNo      String?
  color          String?
  purchasePrice  Decimal   @db.Decimal(12,2)
  status         MotorStatus @default(available)
  imageUrl       String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  loanApplications LoanApplication[]
}

enum MotorStatus {
  available
  reserved
  sold
  repossessed
}

// ---------------- FINANCING TERMS ----------------
model FinancingTerm {
  id           Int       @id @default(autoincrement())
  termYears    Int
  interestRate Decimal   @db.Decimal(5,2)
  createdAt    DateTime  @default(now())

  // Relations
  loanApplications LoanApplication[]
}

// ---------------- LOAN APPLICATIONS ----------------
model LoanApplication {
  id              Int       @id @default(autoincrement())
  firstName       String
  lastName        String
  email           String
  phone           String
  dateOfBirth     DateTime
  address         String
  employmentStatus String
  employerName     String?
  monthlyIncome    Decimal  @db.Decimal(10,2)
  lastPaycheck     DateTime?
  purchasePrice    Decimal  @db.Decimal(12,2)
  monthlyPayment   Decimal  @db.Decimal(12,2)
  totalAmount      Decimal  @db.Decimal(12,2)
  applicationStatus LoanStatus @default(pending)
  riskLevel        RiskLevel? @default(low)
  riskScore        Decimal?  @db.Decimal(5,2)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // FKs
  motorId       Int
  termId        Int
  createdBy     Int

  motor         Motor          @relation(fields: [motorId], references: [id])
  term          FinancingTerm  @relation(fields: [termId], references: [id])
  createdByUser User           @relation(fields: [createdBy], references: [id])

  // Relations
  documents      LoanDocument[]
  payments       Payment[]
  riskAssessments RiskAssessment[]
  repossessions   Repossession[]
}

enum LoanStatus {
  pending
  approved
  rejected
  active
  completed
}

enum RiskLevel {
  low
  medium
  high
}

// ---------------- DOCUMENTS ----------------
model LoanDocument {
  id          Int       @id @default(autoincrement())
  loanId      Int
  docType     DocType
  fileUrl     String
  uploadedAt  DateTime  @default(now())

  loan LoanApplication @relation(fields: [loanId], references: [id])
}

enum DocType {
  proof_of_income
  bank_statement
  valid_id
  others
}

// ---------------- PAYMENTS ----------------
model Payment {
  id          Int       @id @default(autoincrement())
  loanId      Int
  amountDue   Decimal   @db.Decimal(12,2)
  amountPaid  Decimal?  @db.Decimal(12,2)
  dueDate     DateTime
  paidDate    DateTime?
  status      PaymentStatus @default(pending)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  loan LoanApplication @relation(fields: [loanId], references: [id])
}

enum PaymentStatus {
  pending
  paid
  overdue
}

// ---------------- RISK ASSESSMENTS ----------------
model RiskAssessment {
  id                   Int      @id @default(autoincrement())
  loanId               Int
  creditScore          Decimal? @db.Decimal(5,2)
  monthlyIncome        Decimal? @db.Decimal(10,2)
  debtToIncomeRatio    Decimal? @db.Decimal(5,2)
  loanAmount           Decimal? @db.Decimal(12,2)
  paymentHistoryScore  Decimal? @db.Decimal(5,2)
  riskScore            Decimal? @db.Decimal(5,2)
  riskLevel            RiskLevel?
  createdAt            DateTime @default(now())

  loan LoanApplication @relation(fields: [loanId], references: [id])
}

// ---------------- REPOSSESSIONS ----------------
model Repossession {
  id          Int      @id @default(autoincrement())
  loanId      Int
  reason      String?
  status      RepoStatus @default(warning)
  assignedTo  Int
  remarks     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  loan LoanApplication @relation(fields: [loanId], references: [id])
  user User @relation(fields: [assignedTo], references: [id])
}

enum RepoStatus {
  warning
  active
  recovered
  closed
}

// ---------------- ARCHIVES ----------------
model Archive {
  id           Int      @id @default(autoincrement())
  module       String
  recordId     Int
  archivedBy   Int
  reason       String?
  dataSnapshot Json
  createdAt    DateTime @default(now())
  restoredAt   DateTime?
  status       ArchiveStatus @default(archived)

  user User @relation("ArchiveByUser", fields: [archivedBy], references: [id])
}

enum ArchiveStatus {
  archived
  restored
}
