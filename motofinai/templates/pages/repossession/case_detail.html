{% extends "layouts/base.html" %}

{% block title %}Repossession case #{{ case.pk }} · {{ block.super }}{% endblock title %}

{% block content %}
  <div class="mx-auto max-w-4xl px-4 py-10 space-y-8">
    {% include 'components/breadcrumb.html' %}
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold text-slate-900">Application #{{ case.loan_application_id }}</h1>
        <p class="text-sm text-slate-600">{{ case.loan_application.applicant_full_name }} · {{ case.loan_application.motor.display_name }}</p>
      </div>
      <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">
        {{ case.get_status_display }}
      </span>
    </div>

    <section class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Case overview</h2>
          <dl class="mt-4 space-y-3 text-sm text-slate-600">
            <div class="flex items-center justify-between">
              <dt class="font-medium text-slate-700">Overdue installments</dt>
              <dd>{{ case.overdue_installments }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt class="font-medium text-slate-700">Exposure</dt>
              <dd>₱{{ case.total_overdue_amount }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt class="font-medium text-slate-700">Last reminder</dt>
              <dd>{{ case.last_reminder_sent_at|date:"M d, Y"|default:"—" }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt class="font-medium text-slate-700">Opened</dt>
              <dd>{{ case.created_at|date:"M d, Y" }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt class="font-medium text-slate-700">Updated</dt>
              <dd>{{ case.updated_at|date:"M d, Y" }}</dd>
            </div>
            {% if case.closed_at %}
              <div class="flex items-center justify-between">
                <dt class="font-medium text-slate-700">Closed</dt>
                <dd>{{ case.closed_at|date:"M d, Y" }}</dd>
              </div>
            {% endif %}
          </dl>
        </div>
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Loan snapshot</h2>
          <dl class="mt-4 space-y-3 text-sm text-slate-600">
            <div class="flex items-center justify-between">
              <dt class="font-medium text-slate-700">Monthly payment</dt>
              <dd>₱{{ case.loan_application.monthly_payment }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt class="font-medium text-slate-700">Loan status</dt>
              <dd>{{ case.loan_application.get_status_display }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt class="font-medium text-slate-700">Risk level</dt>
              <dd>
                {% if risk_assessment %}
                  {{ risk_assessment.get_risk_level_display }} ({{ risk_assessment.score }})
                {% else %}
                  —
                {% endif %}
              </dd>
            </div>
          </dl>
          <div class="mt-4 flex gap-3 text-sm">
            <a
              href="{% url 'loans:detail' case.loan_application_id %}"
              class="inline-flex items-center rounded-md border border-slate-200 px-3 py-2 font-medium text-sky-600 transition hover:border-sky-200 hover:text-sky-700"
            >View loan</a>
            <a
              href="{% url 'payments:schedule-list' %}?loan={{ case.loan_application_id }}"
              class="inline-flex items-center rounded-md border border-slate-200 px-3 py-2 font-medium text-slate-600 transition hover:border-slate-300 hover:text-slate-700"
            >View schedules</a>
          </div>
        </div>
      </div>

      {% if case.is_open %}
        <div class="mt-8 grid gap-6 md:grid-cols-2">
          <form method="post" action="{% url 'repossession:send-reminder' case.pk %}" class="space-y-3">
        {% csrf_token %}

        <!-- ARIA live region for form errors -->
        <div aria-live="polite" aria-atomic="true" class="sr-only">
          {% if form.errors %}
            Form has {{ form.errors|length }} error{{ form.errors|length|pluralize }}. Please review and correct the highlighted fields.
          {% endif %}
        </div>
            <h3 class="text-base font-semibold text-slate-900">Record reminder</h3>
            <p class="text-sm text-slate-600">Log a follow-up reminder sent to the borrower.</p>
            {% if reminder_form.non_field_errors %}
              <ul class="space-y-1 text-xs text-rose-600">
                {% for error in reminder_form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
            <div class="space-y-1">
              {{ reminder_form.message.label_tag }}
              {{ reminder_form.message }}
              {% if reminder_form.message.help_text %}
                <p class="text-xs text-slate-500">{{ reminder_form.message.help_text }}</p>
              {% endif %}
              {% for error in reminder_form.message.errors %}
                <p class="text-xs text-rose-600">{{ error }}</p>
              {% endfor %}
            </div>
            <button type="submit" class="inline-flex items-center rounded-md bg-amber-500 px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-amber-600">Record reminder</button>
          </form>

          <form method="post" action="{% url 'repossession:close-case' case.pk %}" class="space-y-3">
        {% csrf_token %}

        <!-- ARIA live region for form errors -->
        <div aria-live="polite" aria-atomic="true" class="sr-only">
          {% if form.errors %}
            Form has {{ form.errors|length }} error{{ form.errors|length|pluralize }}. Please review and correct the highlighted fields.
          {% endif %}
        </div>
            <h3 class="text-base font-semibold text-slate-900">Close case</h3>
            <p class="text-sm text-slate-600">Archive the case once the loan is resolved or repossession completed.</p>
            {% if close_form.non_field_errors %}
              <ul class="space-y-1 text-xs text-rose-600">
                {% for error in close_form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
            <div class="space-y-1">
              {{ close_form.notes.label_tag }}
              {{ close_form.notes }}
              {% if close_form.notes.help_text %}
                <p class="text-xs text-slate-500">{{ close_form.notes.help_text }}</p>
              {% endif %}
              {% for error in close_form.notes.errors %}
                <p class="text-xs text-rose-600">{{ error }}</p>
              {% endfor %}
            </div>
            <button type="submit" class="inline-flex items-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-700">Close case</button>
          </form>
        </div>
      {% elif case.resolution_notes %}
        <div class="mt-6 rounded-lg border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-800">
          <h3 class="font-semibold">Resolution notes</h3>
          <p class="mt-1">{{ case.resolution_notes }}</p>
        </div>
      {% endif %}
    </section>

    <section class="rounded-lg border border-slate-200 bg-white shadow-sm">
      <div class="border-b border-slate-200 px-4 py-4">
        <h2 class="text-lg font-semibold text-slate-900">Timeline</h2>
        <p class="mt-1 text-sm text-slate-600">Chronological history of reminders, status changes, and system updates.</p>
      </div>
      <div class="divide-y divide-slate-200">
        {% for event in case.events.all %}
          <article class="px-4 py-4">
            <div class="flex items-center justify-between text-xs uppercase tracking-wide text-slate-500">
              <span>{{ event.get_event_type_display }}</span>
              <span>{{ event.created_at|date:"M d, Y H:i" }}</span>
            </div>
            <p class="mt-2 text-sm text-slate-700">{{ event.description }}</p>
            {% if event.created_by %}
              <p class="mt-1 text-xs text-slate-500">Logged by {{ event.created_by.get_full_name|default:event.created_by.username }}</p>
            {% endif %}
          </article>
        {% empty %}
          <p class="px-4 py-6 text-center text-sm text-slate-500">No activity recorded yet.</p>
        {% endfor %}
      </div>
    </section>
  </div>
{% endblock content %}
