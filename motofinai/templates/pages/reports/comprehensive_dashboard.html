{% extends "layouts/base.html" %}

{% block title %}Comprehensive Reports Dashboard{% endblock title %}

{% block content %}
<section class="mx-auto max-w-7xl px-6 py-12">
  {% include 'components/breadcrumb.html' %}

  <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between mb-8">
    <div>
      <h1 class="text-3xl font-semibold text-slate-900">Comprehensive Reports Dashboard</h1>
      <p class="mt-2 text-sm text-slate-700">Analytics and insights across all operations</p>
    </div>
  </div>

  <!-- Date Filter Form -->
  <div class="mb-8 rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
    <form method="get" class="flex flex-wrap gap-4 items-end">
      <div class="flex-1 min-w-[200px]">
        {{ form.start_date.label_tag }}
        {{ form.start_date }}
      </div>
      <div class="flex-1 min-w-[200px]">
        {{ form.end_date.label_tag }}
        {{ form.end_date }}
      </div>
      <div>
        <button type="submit" class="inline-flex items-center rounded-lg bg-teal-600 px-6 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
          Apply Filters
        </button>
      </div>
    </form>
  </div>

  <!-- KPI Cards -->
  <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">
    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-slate-600">Total Loans</p>
          <p class="mt-2 text-3xl font-bold text-slate-900">{{ total_loans }}</p>
        </div>
        <div class="rounded-full bg-blue-100 p-3">
          <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
      </div>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-slate-600">Collection Rate</p>
          <p class="mt-2 text-3xl font-bold text-emerald-600">{{ collection_rate }}%</p>
        </div>
        <div class="rounded-full bg-emerald-100 p-3">
          <svg class="h-6 w-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-slate-600">Repossession Rate</p>
          <p class="mt-2 text-3xl font-bold text-rose-600">{{ repossession_rate }}%</p>
        </div>
        <div class="rounded-full bg-rose-100 p-3">
          <svg class="h-6 w-6 text-rose-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
      </div>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-slate-600">Motors Loaned</p>
          <p class="mt-2 text-3xl font-bold text-teal-600">{{ motors_loaned_count }}</p>
        </div>
        <div class="rounded-full bg-teal-100 p-3">
          <svg class="h-6 w-6 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row 1 -->
  <div class="grid gap-8 lg:grid-cols-2 mb-8">
    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
      <h2 class="text-lg font-semibold text-slate-900 mb-4">Motors Loaned by Brand</h2>
      <canvas id="motorsBrandChart"></canvas>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
      <h2 class="text-lg font-semibold text-slate-900 mb-4">Payment Status Distribution</h2>
      <canvas id="paymentStatusChart"></canvas>
    </div>
  </div>

  <!-- Charts Row 2 -->
  <div class="grid gap-8 lg:grid-cols-2 mb-8">
    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
      <h2 class="text-lg font-semibold text-slate-900 mb-4">Loan Status Distribution</h2>
      <canvas id="loanStatusChart"></canvas>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
      <h2 class="text-lg font-semibold text-slate-900 mb-4">Collection Trends (Last 12 Months)</h2>
      <canvas id="collectionTrendsChart"></canvas>
    </div>
  </div>

  <!-- Charts Row 3 -->
  <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900 mb-4">Repossession Pipeline</h2>
    <canvas id="repossessionChart"></canvas>
  </div>
</section>
{% endblock content %}

{% block scripts %}
<script>
  // DC Financing brand colors
  const brandColors = {
    primary: '#0f766e',    // teal-700
    secondary: '#14b8a6',  // teal-500
    success: '#10b981',    // emerald-500
    warning: '#f59e0b',    // amber-500
    error: '#ef4444',      // red-500
    info: '#3b82f6',       // blue-500
    slate: ['#cbd5e1', '#94a3b8', '#64748b', '#475569', '#334155'],
  };

  // Motors Loaned by Brand (Bar Chart)
  const motorsBrandCtx = document.getElementById('motorsBrandChart').getContext('2d');
  new Chart(motorsBrandCtx, {
    type: 'bar',
    data: {
      labels: {{ motors_brand_labels_json|safe }},
      datasets: [{
        label: 'Motors Loaned',
        data: {{ motors_brand_data_json|safe }},
        backgroundColor: brandColors.primary,
        borderColor: brandColors.primary,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });

  // Payment Status (Pie Chart)
  const paymentStatusCtx = document.getElementById('paymentStatusChart').getContext('2d');
  new Chart(paymentStatusCtx, {
    type: 'pie',
    data: {
      labels: {{ payment_status_labels_json|safe }},
      datasets: [{
        data: {{ payment_status_data_json|safe }},
        backgroundColor: [
          brandColors.info,     // Due
          brandColors.warning,  // Overdue
          brandColors.success   // Paid
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  // Loan Status (Bar Chart)
  const loanStatusCtx = document.getElementById('loanStatusChart').getContext('2d');
  new Chart(loanStatusCtx, {
    type: 'bar',
    data: {
      labels: {{ loan_status_labels_json|safe }},
      datasets: [{
        label: 'Loans',
        data: {{ loan_status_data_json|safe }},
        backgroundColor: [
          brandColors.slate[2],  // Pending
          brandColors.info,      // Approved
          brandColors.primary,   // Active
          brandColors.success    // Completed
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });

  // Collection Trends (Line Chart)
  const collectionTrendsCtx = document.getElementById('collectionTrendsChart').getContext('2d');
  new Chart(collectionTrendsCtx, {
    type: 'line',
    data: {
      labels: {{ monthly_labels_json|safe }},
      datasets: [{
        label: 'Collections (₱)',
        data: {{ monthly_data_json|safe }},
        borderColor: brandColors.success,
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '₱' + value.toLocaleString();
            }
          }
        }
      }
    }
  });

  // Repossession Pipeline (Bar Chart)
  const repossessionCtx = document.getElementById('repossessionChart').getContext('2d');
  new Chart(repossessionCtx, {
    type: 'bar',
    data: {
      labels: {{ repo_status_labels_json|safe }},
      datasets: [{
        label: 'Cases',
        data: {{ repo_status_data_json|safe }},
        backgroundColor: brandColors.error,
        borderColor: brandColors.error,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
</script>
{% endblock scripts %}
